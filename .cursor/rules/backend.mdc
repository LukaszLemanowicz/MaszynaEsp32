# ReguÅ‚y dla Backend (Node.js + Express + SQLite)

## Stack technologiczny
- **Runtime**: Node.js (najnowsza LTS wersja)
- **Framework**: Express.js (v5.1.0)
- **Baza danych**: SQLite (better-sqlite3) - prosta, bez osobnego serwera
- **Middleware**: cors, body-parser
- **Port**: 4200 (zdefiniowany w `server.js`)

## Struktura projektu
```
backend/
â”œâ”€â”€ server.js              # GÅ‚Ã³wny plik serwera (entry point)
â”œâ”€â”€ config/
â”‚   â””â”€â”€ database.js        # Konfiguracja SQLite
â”œâ”€â”€ models/                # Modele danych
â”‚   â”œâ”€â”€ user.model.js
â”‚   â””â”€â”€ device.model.js
â”œâ”€â”€ routes/                # Endpointy API
â”‚   â”œâ”€â”€ auth.routes.js     # Rejestracja, logowanie
â”‚   â”œâ”€â”€ data.routes.js     # Pobieranie danych
â”‚   â”œâ”€â”€ command.routes.js # Komendy sterujÄ…ce
â”‚   â””â”€â”€ esp32.routes.js   # Endpointy dla ESP32
â”œâ”€â”€ services/              # Logika biznesowa
â”‚   â”œâ”€â”€ auth.service.js
â”‚   â”œâ”€â”€ device.service.js
â”‚   â””â”€â”€ command.service.js
â”œâ”€â”€ middleware/            # Custom middleware
â”‚   â”œâ”€â”€ auth.middleware.js # Weryfikacja tokenu/sesji
â”‚   â””â”€â”€ error.middleware.js
â”œâ”€â”€ utils/                 # Funkcje pomocnicze
â”‚   â””â”€â”€ password.utils.js  # Hashowanie haseÅ‚
â”œâ”€â”€ database/              # Migracje i seed
â”‚   â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ seed.js
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

## Baza danych - SQLite
- **Biblioteka**: `better-sqlite3` (szybsza niÅ¼ `sqlite3`, synchroniczna)
- **Plik bazy**: `backend/database/app.db` (dodaj do `.gitignore`)
- **Migracje**: Proste skrypty SQL w `database/migrations/`
- **Model**: Tylko aktualny stan (brak historii w MVP)

### Schemat bazy danych (MVP):
```sql
-- Tabela uÅ¼ytkownikÃ³w
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  device_id TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Tabela aktualnego stanu urzÄ…dzenia
CREATE TABLE device_state (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  device_id TEXT UNIQUE NOT NULL,
  temperature1 REAL,
  temperature2 REAL,
  temperature3 REAL,
  status TEXT DEFAULT 'offline',
  last_update DATETIME,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Tabela oczekujÄ…cych komend
CREATE TABLE pending_commands (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  device_id TEXT NOT NULL,
  command_type TEXT NOT NULL, -- 'power_on', 'power_off', 'servo'
  command_value REAL, -- dla serwa: 0-100
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  acknowledged BOOLEAN DEFAULT 0,
  acknowledged_at DATETIME
);
```

## Konwencje nazewnictwa
- **Zmienne**: `camelCase` (np. `esp32Data`, `currentPower`)
- **Funkcje**: `camelCase` (np. `authenticateUser()`, `getDeviceData()`)
- **Klasy**: `PascalCase` (np. `UserService`)
- **Endpointy**: RESTful, kebab-case (np. `/api/esp32/data`)
- **Pliki**: `kebab-case.js` (np. `auth.service.js`)

## Organizacja kodu
```javascript
// server.js - struktura
const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');

// Import routes
const authRoutes = require('./routes/auth.routes');
const dataRoutes = require('./routes/data.routes');
// ...

// Middleware
app.use(cors());
app.use(bodyParser.json());

// Routes
app.use('/api/auth', authRoutes);
app.use('/api/data', dataRoutes);
// ...

// Error handling
app.use(errorMiddleware);

// Start server
app.listen(PORT, () => { /* ... */ });
```

## Endpointy API

### ESP32 â†’ Backend
- `POST /api/esp32/data` - Odbieranie danych z ESP32 (temperatury)
- `GET /api/esp32/power` - ESP32 pobiera moc
- `GET /api/esp32/commands` - ESP32 pobiera oczekujÄ…ce komendy
- `POST /api/esp32/command/ack` - ESP32 potwierdza wykonanie komendy

### Frontend â†’ Backend
- `POST /api/auth/register` - Rejestracja uÅ¼ytkownika
- `POST /api/auth/login` - Logowanie
- `POST /api/auth/logout` - Wylogowanie
- `GET /api/data` - Pobieranie aktualnych danych (polling co 5s)
- `POST /api/command/power` - Komenda ON/OFF
- `POST /api/command/servo` - Komenda ustawienia serwa

## ObsÅ‚uga bÅ‚Ä™dÃ³w
- **Status codes**: 
  - `200` - sukces
  - `400` - bÅ‚Ä…d walidacji
  - `401` - brak autoryzacji
  - `404` - nie znaleziono
  - `500` - bÅ‚Ä…d serwera
- **Format odpowiedzi bÅ‚Ä™dÃ³w**:
```javascript
{
  "error": "Opis bÅ‚Ä™du",
  "code": "ERROR_CODE",
  "details": {} // opcjonalne
}
```
- **Logowanie**: UÅ¼ywaj `console.log()` z emoji dla czytelnoÅ›ci
- **Error middleware**: Globalna obsÅ‚uga bÅ‚Ä™dÃ³w

## Autoryzacja
- **JWT lub session**: Token/sesja dla autoryzacji
- **Middleware**: `authMiddleware` dla chronionych endpointÃ³w
- **Wszystkie endpointy**: WymagajÄ… autoryzacji (oprÃ³cz ESP32 endpoints i auth)
- **DeviceId**: UÅ¼ytkownik powiÄ…zany z `deviceId` (z bazy danych)

## Walidacja
- **Input validation**: Sprawdzaj dane wejÅ›ciowe przed przetworzeniem
- **Walidacja mocy**: 0-1000W
- **Walidacja serwa**: 0-100
- **Walidacja uÅ¼ytkownika**: Unikalny username, hasÅ‚o min. 8 znakÃ³w

## Haszowanie haseÅ‚
- **Biblioteka**: `bcrypt` lub `bcryptjs`
- **Rounds**: Minimum 10 rounds
- **Nie przechowuj**: HaseÅ‚ w plain text

## SQLite - Best practices
- **PoÅ‚Ä…czenie**: Jeden connection pool dla caÅ‚ej aplikacji
- **Transakcje**: UÅ¼ywaj transakcji dla operacji wieloetapowych
- **Prepared statements**: Zawsze uÅ¼ywaj prepared statements (zapobiega SQL injection)
- **Backup**: Regularne kopie zapasowe pliku `.db` (nie w MVP)

### PrzykÅ‚ad uÅ¼ycia SQLite:
```javascript
const Database = require('better-sqlite3');
const db = new Database('database/app.db');

// Prepared statement
const getUser = db.prepare('SELECT * FROM users WHERE username = ?');
const user = getUser.get(username);

// Transaction
const insertUser = db.transaction((username, passwordHash, deviceId) => {
  const stmt = db.prepare('INSERT INTO users (username, password_hash, device_id) VALUES (?, ?, ?)');
  return stmt.run(username, passwordHash, deviceId);
});
```

## Polling i status online/offline
- **Timeout**: UrzÄ…dzenie offline jeÅ›li brak aktualizacji przez 10 sekund (do doprecyzowania)
- **Status**: Aktualizowany przy kaÅ¼dym `POST /api/esp32/data`
- **Last update**: Przechowywany w `device_state.last_update`

## Komendy
- **Kolejka komend**: Przechowywane w `pending_commands`
- **ACK**: Po potwierdzeniu przez ESP32, ustaw `acknowledged = 1`
- **Czyszczenie**: UsuÅ„ stare komendy (np. starsze niÅ¼ 1 minuta)

## Middleware
- `cors()` - wÅ‚Ä…czone dla wszystkich Å¼Ä…daÅ„
- `bodyParser.json()` - parsowanie JSON
- `bodyParser.urlencoded()` - parsowanie form data
- `authMiddleware` - weryfikacja tokenu/sesji
- `errorMiddleware` - globalna obsÅ‚uga bÅ‚Ä™dÃ³w

## Logowanie
- **Format**: `console.log()` z emoji dla czytelnoÅ›ci
- **PrzykÅ‚ady**: 
  - `console.log('ğŸ“¡ Otrzymano dane z ESP32:', data)`
  - `console.log('âœ… UÅ¼ytkownik zalogowany:', username)`
  - `console.log('âŒ BÅ‚Ä…d:', error)`

## Antywzorce - NIE RÃ“B TEGO
- âŒ Nie przechowuj haseÅ‚ w plain text
- âŒ Nie uÅ¼ywaj SQL bez prepared statements (SQL injection)
- âŒ Nie mieszaj logiki biznesowej w routes - uÅ¼ywaj services
- âŒ Nie ignoruj bÅ‚Ä™dÃ³w - zawsze obsÅ‚uguj i loguj
- âŒ Nie hardcoduj wartoÅ›ci - uÅ¼ywaj zmiennych Å›rodowiskowych
- âŒ Nie zapominaj o walidacji danych wejÅ›ciowych
- âŒ Nie uÅ¼ywaj synchronicznych operacji blokujÄ…cych (oprÃ³cz SQLite)

## Dobre praktyki
- âœ… UÅ¼ywaj prepared statements dla SQL
- âœ… Wydziel logikÄ™ do services
- âœ… Waliduj wszystkie dane wejÅ›ciowe
- âœ… UÅ¼ywaj transakcji dla operacji wieloetapowych
- âœ… Hashuj hasÅ‚a przed zapisem
- âœ… Loguj waÅ¼ne operacje
- âœ… ObsÅ‚uguj bÅ‚Ä™dy gracefully
- âœ… UÅ¼ywaj middleware dla wspÃ³lnej logiki
- âœ… Dokumentuj endpointy API

## Zmienne Å›rodowiskowe
- **Plik**: `.env` (dodaj do `.gitignore`)
- **Biblioteka**: `dotenv` do Å‚adowania zmiennych
- **PrzykÅ‚ady**: `PORT`, `DB_PATH`, `JWT_SECRET`, `BCRYPT_ROUNDS`

## Testowanie
- **Testowe Å¼Ä…dania**: `test-requests.http` (juÅ¼ istnieje)
- **Testy jednostkowe**: Do zaimplementowania (Jest/Mocha)
- **Testy integracyjne**: Do zaimplementowania
